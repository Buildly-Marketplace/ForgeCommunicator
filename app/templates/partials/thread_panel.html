<!-- Thread Panel Partial -->
<div id="thread-panel" class="fixed inset-y-0 right-0 w-96 glass-dark shadow-xl transform translate-x-full transition-transform duration-300 ease-in-out z-50 flex flex-col border-l border-white/10">
    <!-- Header -->
    <div class="flex-shrink-0 px-4 py-3 border-b border-white/10 flex items-center justify-between bg-dark-900/80">
        <h3 class="text-lg font-medium text-white">Thread</h3>
        <div class="flex items-center space-x-1">
            <!-- Save to notes button -->
            <button id="save-thread-btn" onclick="saveThreadToNotes()" 
                    class="p-1.5 rounded hover:bg-white/10 text-gray-400 hover:text-green-400 transition-colors"
                    title="Save thread to notes">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z"/>
                </svg>
            </button>
            <!-- Export thread button -->
            <button id="export-thread-btn" onclick="exportThread()" 
                    class="p-1.5 rounded hover:bg-white/10 text-gray-400 hover:text-blue-400 transition-colors"
                    title="Export thread as Markdown">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                </svg>
            </button>
            <button onclick="closeThread()" class="p-1.5 rounded hover:bg-white/10 text-gray-400 hover:text-white transition-colors">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                </svg>
            </button>
        </div>
    </div>
    
    <!-- Thread content container -->
    <div id="thread-content" class="flex-1 flex flex-col overflow-hidden">
        <!-- Will be populated via HTMX -->
    </div>
</div>

<!-- Thread Panel Scripts -->
<script>
(function() {
    // Avoid re-initialization if already loaded
    if (window._threadPanelInitialized) return;
    window._threadPanelInitialized = true;
    window.currentThreadId = null;

    window.openThread = function(messageId) {
        window.currentThreadId = messageId;
        const panel = document.getElementById('thread-panel');
        const content = document.getElementById('thread-content');
        
        // Show panel
        panel.classList.remove('translate-x-full');
        
        // Load thread content
        htmx.ajax('GET', `/workspaces/${window.workspaceId}/channels/${window.channelId}/messages/${messageId}/thread`, {
            target: '#thread-content',
            swap: 'innerHTML'
        });
    };

    window.closeThread = function() {
        window.currentThreadId = null;
        const panel = document.getElementById('thread-panel');
        panel.classList.add('translate-x-full');
    };
    
    window.exportThread = function() {
        if (window.currentThreadId) {
            window.location.href = `/workspaces/${window.workspaceId}/channels/${window.channelId}/messages/${window.currentThreadId}/thread/export`;
        }
    };
    
    window.saveThreadToNotes = function() {
        if (window.currentThreadId) {
            htmx.ajax('POST', `/notes/from-thread/${window.currentThreadId}`, {
                swap: 'none'
            }).then(() => {
                // Show brief confirmation
                const btn = document.getElementById('save-thread-btn');
                btn.classList.add('text-green-400');
                setTimeout(() => btn.classList.remove('text-green-400'), 2000);
            });
        }
    };

    // Close thread on escape
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape' && window.currentThreadId) {
            window.closeThread();
        }
    });

    // Handle thread reply form submission
    document.addEventListener('htmx:afterSwap', function(e) {
        if (e.detail.target.id === 'thread-replies') {
            // Clear the input
            const input = document.querySelector('#thread-reply-form textarea');
            if (input) {
                input.value = '';
            }
            // Scroll to bottom
            const repliesContainer = document.getElementById('thread-replies');
            if (repliesContainer) {
                repliesContainer.scrollTop = repliesContainer.scrollHeight;
            }
            // Update reply count in main message
            if (window.currentThreadId) {
                const mainMessage = document.getElementById(`message-${window.currentThreadId}`);
                if (mainMessage) {
                    // Refresh to update count
                    htmx.ajax('GET', `/workspaces/${window.workspaceId}/channels/${window.channelId}/messages/${window.currentThreadId}?partial=true`, {
                        target: `#message-${window.currentThreadId}`,
                        swap: 'outerHTML'
                    });
                }
            }
        }
    });
})();
</script>
