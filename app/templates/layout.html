<!DOCTYPE html>
<html lang="en" class="h-full dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>{% block title %}{{ brand.full_name }}{% endblock %}</title>
    
    <!-- PWA Meta Tags -->
    <meta name="description" content="Team communication and collaboration platform">
    <meta name="theme-color" content="#3b82f6">
    <meta name="mobile-web-app-capable" content="yes">
    
    <!-- iOS PWA Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Forge">
    <meta name="format-detection" content="telephone=no">
    
    <!-- Web App Manifest -->
    <link rel="manifest" href="/static/manifest.json">
    
    <!-- Standard Favicon -->
    <link rel="icon" type="image/svg+xml" href="{{ brand.favicon_url }}">
    
    <!-- Apple Touch Icons (iOS) -->
    <link rel="apple-touch-icon" href="/static/icons/icon-180x180.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/static/icons/icon-180x180.png">
    <link rel="apple-touch-icon" sizes="152x152" href="/static/icons/icon-152x152.png">
    <link rel="apple-touch-icon" sizes="144x144" href="/static/icons/icon-144x144.png">
    <link rel="apple-touch-icon" sizes="120x120" href="/static/icons/icon-128x128.png">
    
    <!-- iOS Splash Screens -->
    <link rel="apple-touch-startup-image" href="/static/icons/icon-512x512.png">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        brand: {
                            primary: '{{ brand.primary_color }}',
                            secondary: '{{ brand.secondary_color }}',
                            accent: '{{ brand.accent_color }}',
                        },
                        // Futuristic theme colors
                        forge: {
                            navy: '{{ brand.secondary_color }}',
                            blue: '{{ brand.primary_color }}',
                            purple: '{{ brand.accent_color }}',
                        },
                        // Dark theme backgrounds
                        dark: {
                            950: '#050d1a',
                            900: '#0a1628',
                            800: '#0f172a',
                            700: '#1a2744',
                            600: '#1e293b',
                            500: '#334155',
                        }
                    }
                }
            }
        }
    </script>
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <script src="https://unpkg.com/htmx.org@1.9.10/dist/ext/ws.js"></script>
    <script>
        // Detect PWA/standalone mode
        (function() {
            var isStandalone = window.matchMedia('(display-mode: standalone)').matches || 
                               window.navigator.standalone === true;
            
            // Add PWA mode header to all HTMX requests for better session handling
            if (isStandalone) {
                document.body.addEventListener('htmx:configRequest', function(evt) {
                    evt.detail.headers['X-PWA-Mode'] = 'standalone';
                });
            }
        })();
        
        // Suppress WebSocket close errors from htmx ws extension during navigation
        (function() {
            var originalError = console.error;
            console.error = function() {
                var args = Array.prototype.slice.call(arguments);
                var msg = args.join(' ');
                // Suppress known htmx ws.js errors during page navigation
                if (msg.includes("Cannot read properties of undefined (reading 'close')") ||
                    msg.includes("maybeCloseWebSocketSource")) {
                    return; // Suppress this error
                }
                originalError.apply(console, arguments);
            };
        })();
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        }
        
        :root {
            --brand-primary: {{ brand.primary_color }};
            --brand-secondary: {{ brand.secondary_color }};
            --brand-accent: {{ brand.accent_color }};
        }
        [x-cloak] { display: none !important; }
        .htmx-indicator { opacity: 0; transition: opacity 200ms ease-in; }
        .htmx-request .htmx-indicator { opacity: 1; }
        .htmx-request.htmx-indicator { opacity: 1; }
        
        /* Futuristic space background */
        .forge-bg {
            background: linear-gradient(135deg, #0a1628 0%, #1a2744 50%, #0f172a 100%);
            position: relative;
        }
        
        .forge-bg::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                radial-gradient(ellipse at 20% 80%, rgba(59, 130, 246, 0.12) 0%, transparent 50%),
                radial-gradient(ellipse at 80% 20%, rgba(168, 85, 247, 0.08) 0%, transparent 50%),
                radial-gradient(ellipse at 50% 50%, rgba(14, 165, 233, 0.06) 0%, transparent 70%);
            pointer-events: none;
            z-index: 0;
        }
        
        /* Twinkling stars */
        .stars {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-image: 
                radial-gradient(2px 2px at 20px 30px, rgba(255,255,255,0.3), transparent),
                radial-gradient(2px 2px at 40px 70px, rgba(255,255,255,0.2), transparent),
                radial-gradient(1px 1px at 90px 40px, rgba(255,255,255,0.3), transparent),
                radial-gradient(2px 2px at 160px 120px, rgba(255,255,255,0.2), transparent),
                radial-gradient(1px 1px at 230px 90px, rgba(255,255,255,0.4), transparent),
                radial-gradient(2px 2px at 300px 60px, rgba(255,255,255,0.2), transparent),
                radial-gradient(1px 1px at 350px 150px, rgba(255,255,255,0.3), transparent),
                radial-gradient(2px 2px at 420px 80px, rgba(255,255,255,0.2), transparent),
                radial-gradient(1px 1px at 500px 200px, rgba(255,255,255,0.25), transparent),
                radial-gradient(2px 2px at 580px 140px, rgba(255,255,255,0.15), transparent),
                radial-gradient(1px 1px at 650px 50px, rgba(255,255,255,0.35), transparent),
                radial-gradient(2px 2px at 720px 180px, rgba(255,255,255,0.2), transparent);
            background-size: 800px 250px;
            animation: twinkle 10s linear infinite;
            pointer-events: none;
            z-index: 0;
        }
        
        @keyframes twinkle {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }
        
        /* Floating particles */
        .floating-particles {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            overflow: hidden;
            pointer-events: none;
            z-index: 0;
        }
        
        .particle {
            position: absolute;
            width: 4px;
            height: 4px;
            background: rgba(59, 130, 246, 0.5);
            border-radius: 50%;
            animation: float 8s infinite ease-in-out;
        }
        
        .particle:nth-child(1) { left: 10%; top: 20%; animation-delay: 0s; }
        .particle:nth-child(2) { left: 20%; top: 60%; animation-delay: 1s; background: rgba(168, 85, 247, 0.5); }
        .particle:nth-child(3) { left: 30%; top: 40%; animation-delay: 2s; }
        .particle:nth-child(4) { left: 50%; top: 80%; animation-delay: 3s; background: rgba(168, 85, 247, 0.5); }
        .particle:nth-child(5) { left: 70%; top: 30%; animation-delay: 4s; }
        .particle:nth-child(6) { left: 80%; top: 70%; animation-delay: 5s; background: rgba(14, 165, 233, 0.5); }
        .particle:nth-child(7) { left: 90%; top: 50%; animation-delay: 6s; }
        .particle:nth-child(8) { left: 15%; top: 85%; animation-delay: 7s; background: rgba(14, 165, 233, 0.5); }
        
        @keyframes float {
            0%, 100% { transform: translateY(0) scale(1); opacity: 0.5; }
            50% { transform: translateY(-20px) scale(1.2); opacity: 0.9; }
        }
        
        /* Custom scrollbar - dark theme */
        .scrollbar-thin::-webkit-scrollbar { width: 6px; }
        .scrollbar-thin::-webkit-scrollbar-track { background: rgba(30, 41, 59, 0.5); }
        .scrollbar-thin::-webkit-scrollbar-thumb { background: rgba(71, 85, 105, 0.7); border-radius: 3px; }
        .scrollbar-thin::-webkit-scrollbar-thumb:hover { background: rgba(100, 116, 139, 0.8); }
        
        /* Message hover actions */
        .message-item:hover .message-actions { opacity: 1; }
        .message-actions { opacity: 0; transition: opacity 150ms; }
        
        /* Mention dropdown */
        .mention-dropdown { max-height: 200px; overflow-y: auto; }
        
        /* Brand-colored elements */
        .bg-brand-primary { background-color: var(--brand-primary); }
        .text-brand-primary { color: var(--brand-primary); }
        .border-brand-primary { border-color: var(--brand-primary); }
        .hover\\:bg-brand-primary:hover { background-color: var(--brand-primary); }
        
        /* Futuristic glow effects */
        .glow-text { text-shadow: 0 0 30px rgba(59, 130, 246, 0.5); }
        .glow-border { box-shadow: 0 0 20px rgba(59, 130, 246, 0.3); }
        .glow-accent { box-shadow: 0 0 25px rgba(168, 85, 247, 0.3); }
        
        /* Glass morphism effect */
        .glass {
            backdrop-filter: blur(20px);
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .glass-dark {
            backdrop-filter: blur(20px);
            background: rgba(15, 23, 42, 0.7);
            border: 1px solid rgba(255, 255, 255, 0.08);
        }
        
        /* Animations */
        @keyframes fade-in {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in {
            animation: fade-in 0.3s ease-out forwards;
        }
        
        /* Content layer - above background effects */
        .content-layer {
            position: relative;
            z-index: 1;
        }
        
        /* Smooth transitions for theme */
        .theme-transition {
            transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
        }
    </style>
    {% block head %}{% endblock %}
    <script>
        // Initialize theme from localStorage or default to dark
        (function() {
            const prefersDark = {{ 'true' if brand.dark_mode_default else 'false' }};
            if (localStorage.theme === 'light') {
                document.documentElement.classList.remove('dark');
            } else if (localStorage.theme === 'dark' || prefersDark) {
                document.documentElement.classList.add('dark');
            } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
                document.documentElement.classList.add('dark');
            }
        })();
    </script>
</head>
<body class="h-full forge-bg text-gray-100 theme-transition" hx-boost="true">
    <!-- Background effects -->
    <div class="stars"></div>
    <div class="floating-particles">
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
    </div>
    
    {% block body %}
    <div class="min-h-full content-layer">
        {% block content %}{% endblock %}
    </div>
    {% endblock %}
    
    <!-- Toast notifications -->
    <div id="toast-container" class="fixed bottom-4 right-4 z-50 space-y-2"></div>
    
    <!-- Push Notification Prompt Banner -->
    {% if user %}
    <div id="push-notification-prompt" class="hidden fixed top-0 left-0 right-0 z-50 bg-gradient-to-r from-blue-600 to-indigo-600 shadow-lg">
        <div class="max-w-7xl mx-auto px-4 py-3">
            <div class="flex items-center justify-between flex-wrap">
                <div class="flex items-center flex-1 min-w-0">
                    <span class="flex p-2 rounded-lg bg-blue-800">
                        <svg class="h-5 w-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"/>
                        </svg>
                    </span>
                    <p class="ml-3 text-sm font-medium text-white truncate">
                        <span class="hidden md:inline">Enable notifications to stay updated on messages and @mentions!</span>
                        <span class="md:hidden">Enable notifications for messages!</span>
                    </p>
                </div>
                <div class="flex-shrink-0 order-3 w-full sm:order-2 sm:w-auto mt-2 sm:mt-0 sm:ml-4">
                    <button id="enable-push-btn" type="button"
                            class="flex items-center justify-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-blue-600 bg-white hover:bg-blue-50 transition-colors">
                        Enable Notifications
                    </button>
                </div>
                <div class="order-2 flex-shrink-0 sm:order-3 sm:ml-2">
                    <button id="dismiss-push-prompt" type="button"
                            class="-mr-1 flex p-2 rounded-md hover:bg-blue-500 focus:outline-none focus:ring-2 focus:ring-white transition-colors">
                        <span class="sr-only">Dismiss</span>
                        <svg class="h-5 w-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                        </svg>
                    </button>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
    
    <!-- Session timeout warning modal -->
    <div id="session-timeout-modal" class="hidden fixed inset-0 z-[100] overflow-y-auto" role="dialog" aria-modal="true" aria-labelledby="session-timeout-title">
        <div class="flex items-center justify-center min-h-screen px-4">
            <div class="fixed inset-0 bg-black bg-opacity-60 transition-opacity"></div>
            <div class="relative glass-dark rounded-xl shadow-2xl transform transition-all w-full max-w-md p-6 glow-border">
                <div class="text-center">
                    <!-- Warning icon -->
                    <div class="mx-auto flex items-center justify-center h-16 w-16 rounded-full bg-yellow-500/20 mb-4">
                        <svg class="h-8 w-8 text-yellow-400" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126zM12 15.75h.007v.008H12v-.008z" />
                        </svg>
                    </div>
                    
                    <h3 id="session-timeout-title" class="text-xl font-semibold text-white mb-2">Session Expiring Soon</h3>
                    <p class="text-gray-300 mb-2">Your session will expire in <span id="session-countdown" class="font-bold text-yellow-400">5:00</span></p>
                    <p class="text-sm text-gray-400 mb-6" id="session-timeout-message">Please save any unsaved work before continuing.</p>
                    
                    <!-- Unsaved work indicator -->
                    <div id="unsaved-work-warning" class="hidden bg-red-500/20 border border-red-500/40 rounded-lg p-3 mb-6">
                        <div class="flex items-center text-red-300">
                            <svg class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m9-.75a9 9 0 11-18 0 9 9 0 0118 0zm-9 3.75h.008v.008H12v-.008z" />
                            </svg>
                            <span class="text-sm font-medium">You have unsaved changes that may be lost!</span>
                        </div>
                    </div>
                    
                    <div class="flex flex-col sm:flex-row gap-3">
                        <button type="button" onclick="sessionMonitor.extendSession()" 
                                class="flex-1 px-4 py-2.5 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-medium transition-colors focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 focus:ring-offset-gray-800">
                            Stay Logged In
                        </button>
                        <button type="button" onclick="sessionMonitor.logout()"
                                class="flex-1 px-4 py-2.5 bg-gray-600 hover:bg-gray-500 text-white rounded-lg font-medium transition-colors focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2 focus:ring-offset-gray-800">
                            Log Out Now
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Session expired modal (shown when session already expired) -->
    <div id="session-expired-modal" class="hidden fixed inset-0 z-[100] overflow-y-auto" role="dialog" aria-modal="true">
        <div class="flex items-center justify-center min-h-screen px-4">
            <div class="fixed inset-0 bg-black bg-opacity-70 transition-opacity"></div>
            <div class="relative glass-dark rounded-xl shadow-2xl transform transition-all w-full max-w-md p-6 glow-border">
                <div class="text-center">
                    <!-- Error icon -->
                    <div class="mx-auto flex items-center justify-center h-16 w-16 rounded-full bg-red-500/20 mb-4">
                        <svg class="h-8 w-8 text-red-400" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 5.25a3 3 0 013 3m3 0a6 6 0 01-7.029 5.912c-.563-.097-1.159.026-1.563.43L10.5 17.25H8.25v2.25H6v2.25H2.25v-2.818c0-.597.237-1.17.659-1.591l6.499-6.499c.404-.404.527-1 .43-1.563A6 6 0 1121.75 8.25z" />
                        </svg>
                    </div>
                    
                    <h3 class="text-xl font-semibold text-white mb-2">Session Expired</h3>
                    <p class="text-gray-300 mb-6">Your session has expired. Please log in again to continue.</p>
                    
                    <a href="/auth/login" 
                       class="inline-block w-full px-4 py-2.5 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-medium transition-colors focus:outline-none focus:ring-2 focus:ring-blue-500">
                        Log In Again
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Command palette -->
    <div id="command-palette" class="hidden fixed inset-0 z-50 overflow-y-auto" aria-labelledby="modal-title" role="dialog" aria-modal="true">
        <div class="flex items-start justify-center min-h-screen pt-20 px-4 text-center">
            <div class="fixed inset-0 bg-gray-500 dark:bg-gray-900 bg-opacity-75 dark:bg-opacity-80 transition-opacity" onclick="closeCommandPalette()"></div>
            <div class="relative bg-white dark:bg-gray-800 rounded-lg shadow-xl transform transition-all w-full max-w-lg">
                <div class="p-4">
                    <input type="text" 
                           id="command-input" 
                           class="w-full px-4 py-3 text-lg border-0 bg-transparent text-gray-900 dark:text-white focus:ring-0 focus:outline-none"
                           placeholder="Type a command or search..."
                           autocomplete="off">
                </div>
                <div id="command-results" class="max-h-96 overflow-y-auto border-t dark:border-gray-700">
                    <!-- Results populated by JS -->
                </div>
            </div>
        </div>
    </div>
    
    <script src="/static/app.js"></script>
    <script>
        // Fix htmx ws.js close error when navigating away
        // This suppresses "Cannot read properties of undefined (reading 'close')" errors
        window.addEventListener('beforeunload', function() {
            // Mark that we're navigating away to suppress errors
            window._navigatingAway = true;
        });
        
        // Patch htmx to handle WebSocket cleanup gracefully
        document.addEventListener('htmx:beforeSwap', function(e) {
            // Close any WebSocket connections before swapping content
            const wsElements = document.querySelectorAll('[hx-ext*="ws"]');
            wsElements.forEach(function(el) {
                if (el._htmxWebSocket) {
                    try {
                        el._htmxWebSocket.close();
                    } catch (err) {
                        // Ignore close errors
                    }
                }
            });
        });
        
        // Register service worker for PWA and push notifications
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/static/sw.js')
                    .then(registration => {
                        console.log('Service Worker registered:', registration.scope);
                        
                        // Check for updates periodically
                        setInterval(() => {
                            registration.update();
                        }, 60 * 60 * 1000); // Check every hour
                    })
                    .catch(error => {
                        console.error('Service Worker registration failed:', error);
                    });
                
                // Listen for messages from Service Worker (push notifications)
                navigator.serviceWorker.addEventListener('message', (event) => {
                    if (event.data && event.data.type === 'PUSH_RECEIVED') {
                        console.log('Push notification received in app:', event.data);
                        // Play in-app notification sound as backup
                        if (window.playNotificationSound) {
                            window.playNotificationSound();
                        } else {
                            // Fallback: create simple notification sound
                            try {
                                const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                                const oscillator = audioCtx.createOscillator();
                                const gainNode = audioCtx.createGain();
                                oscillator.connect(gainNode);
                                gainNode.connect(audioCtx.destination);
                                oscillator.type = 'sine';
                                oscillator.frequency.setValueAtTime(800, audioCtx.currentTime);
                                oscillator.frequency.exponentialRampToValueAtTime(1600, audioCtx.currentTime + 0.1);
                                oscillator.frequency.exponentialRampToValueAtTime(1200, audioCtx.currentTime + 0.15);
                                gainNode.gain.setValueAtTime(0.3, audioCtx.currentTime);
                                gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.2);
                                oscillator.start(audioCtx.currentTime);
                                oscillator.stop(audioCtx.currentTime + 0.2);
                            } catch (e) {
                                console.log('Could not play notification sound:', e);
                            }
                        }
                        // Show toast notification if available
                        if (window.showToast) {
                            window.showToast(event.data.body, 'info');
                        }
                    }
                });
            });
        }
        
        // ============================================
        // Push Notification Prompt
        // ============================================
        {% if user %}
        (async function initPushPrompt() {
            const promptEl = document.getElementById('push-notification-prompt');
            const enableBtn = document.getElementById('enable-push-btn');
            const dismissBtn = document.getElementById('dismiss-push-prompt');
            
            if (!promptEl) return;
            
            // Check if user dismissed the prompt recently (don't show for 7 days)
            const dismissedAt = localStorage.getItem('pushPromptDismissed');
            if (dismissedAt) {
                const daysSinceDismiss = (Date.now() - parseInt(dismissedAt)) / (1000 * 60 * 60 * 24);
                if (daysSinceDismiss < 7) return;
            }
            
            // Check browser support
            if (!('serviceWorker' in navigator) || !('PushManager' in window)) {
                console.log('Push notifications not supported');
                return;
            }
            
            // Check if server has push configured
            try {
                const response = await fetch('/push/vapid-public-key');
                if (!response.ok) return;
            } catch (e) {
                return;
            }
            
            // Check if already subscribed - verify both browser AND server have the subscription
            try {
                const registration = await navigator.serviceWorker.ready;
                const subscription = await registration.pushManager.getSubscription();
                if (subscription) {
                    // Browser has subscription - verify server also has it
                    const statusResponse = await fetch('/push/status');
                    if (statusResponse.ok) {
                        const status = await statusResponse.json();
                        if (status.subscription_count > 0) {
                            console.log('Already subscribed to push notifications (server confirmed)');
                            return;
                        }
                        // Server doesn't have subscription - re-register it
                        console.log('Browser subscribed but server missing - re-registering');
                        const arrayBufferToBase64url = (buffer) => {
                            const bytes = new Uint8Array(buffer);
                            let binary = '';
                            for (let i = 0; i < bytes.byteLength; i++) {
                                binary += String.fromCharCode(bytes[i]);
                            }
                            return btoa(binary).replace(/\+/g, '-').replace(/\//g, '_').replace(/=/g, '');
                        };
                        const formData = new FormData();
                        formData.append('endpoint', subscription.endpoint);
                        formData.append('p256dh', arrayBufferToBase64url(subscription.getKey('p256dh')));
                        formData.append('auth', arrayBufferToBase64url(subscription.getKey('auth')));
                        await fetch('/push/subscribe', { method: 'POST', body: formData });
                        console.log('Re-registered existing subscription with server');
                        return;
                    }
                }
            } catch (e) {
                console.log('Could not check push subscription:', e);
                // Continue to show prompt
            }
            
            // Check permission state
            if (Notification.permission === 'denied') {
                return; // User blocked notifications, don't prompt
            }
            
            // Helper function to subscribe
            async function subscribeToNotifications() {
                try {
                    // Get VAPID public key
                    const response = await fetch('/push/vapid-public-key');
                    const { publicKey } = await response.json();
                    
                    // Subscribe
                    const registration = await navigator.serviceWorker.ready;
                    const subscription = await registration.pushManager.subscribe({
                        userVisibleOnly: true,
                        applicationServerKey: urlBase64ToUint8Array(publicKey)
                    });
                    
                    // Convert keys to base64url
                    const arrayBufferToBase64url = (buffer) => {
                        const bytes = new Uint8Array(buffer);
                        let binary = '';
                        for (let i = 0; i < bytes.byteLength; i++) {
                            binary += String.fromCharCode(bytes[i]);
                        }
                        return btoa(binary).replace(/\+/g, '-').replace(/\//g, '_').replace(/=/g, '');
                    };
                    
                    // Send to server
                    const formData = new FormData();
                    formData.append('endpoint', subscription.endpoint);
                    formData.append('p256dh', arrayBufferToBase64url(subscription.getKey('p256dh')));
                    formData.append('auth', arrayBufferToBase64url(subscription.getKey('auth')));
                    
                    const subResponse = await fetch('/push/subscribe', {
                        method: 'POST',
                        body: formData,
                    });
                    
                    if (subResponse.ok) {
                        console.log('Successfully subscribed to push notifications');
                        return true;
                    }
                } catch (e) {
                    console.error('Error subscribing to notifications:', e);
                }
                return false;
            }
            
            if (Notification.permission === 'granted') {
                // Permission granted but no Browser subscription - auto-subscribe silently
                console.log('Permission granted but no subscription - auto-subscribing...');
                const success = await subscribeToNotifications();
                if (success) {
                    if (window.showToast) {
                        window.showToast('Notifications re-enabled!', 'success');
                    }
                    return;
                }
                // If auto-subscribe failed, show the prompt as fallback
            }
            
            // Show the prompt with a slight delay
            setTimeout(() => {
                promptEl.classList.remove('hidden');
            }, 2000);
            
            // Handle enable button
            enableBtn.addEventListener('click', async () => {
                try {
                    enableBtn.textContent = 'Enabling...';
                    enableBtn.disabled = true;
                    
                    // Request permission
                    const permission = await Notification.requestPermission();
                    if (permission !== 'granted') {
                        promptEl.classList.add('hidden');
                        return;
                    }
                    
                    // Get VAPID public key
                    const response = await fetch('/push/vapid-public-key');
                    const { publicKey } = await response.json();
                    
                    // Subscribe
                    const registration = await navigator.serviceWorker.ready;
                    const subscription = await registration.pushManager.subscribe({
                        userVisibleOnly: true,
                        applicationServerKey: urlBase64ToUint8Array(publicKey)
                    });
                    
                    // Convert keys to base64url
                    const arrayBufferToBase64url = (buffer) => {
                        const bytes = new Uint8Array(buffer);
                        let binary = '';
                        for (let i = 0; i < bytes.byteLength; i++) {
                            binary += String.fromCharCode(bytes[i]);
                        }
                        return btoa(binary).replace(/\+/g, '-').replace(/\//g, '_').replace(/=/g, '');
                    };
                    
                    // Send to server
                    const formData = new FormData();
                    formData.append('endpoint', subscription.endpoint);
                    formData.append('p256dh', arrayBufferToBase64url(subscription.getKey('p256dh')));
                    formData.append('auth', arrayBufferToBase64url(subscription.getKey('auth')));
                    
                    await fetch('/push/subscribe', {
                        method: 'POST',
                        body: formData,
                    });
                    
                    promptEl.classList.add('hidden');
                    if (window.showToast) {
                        window.showToast('Notifications enabled! You\'ll now receive alerts for new messages.', 'success');
                    }
                } catch (e) {
                    console.error('Failed to enable notifications:', e);
                    enableBtn.textContent = 'Enable Notifications';
                    enableBtn.disabled = false;
                    if (window.showToast) {
                        window.showToast('Failed to enable notifications. Please try again.', 'error');
                    }
                }
            });
            
            // Handle dismiss button
            dismissBtn.addEventListener('click', () => {
                promptEl.classList.add('hidden');
                localStorage.setItem('pushPromptDismissed', Date.now().toString());
            });
        })();
        {% endif %}
        
        // PWA Install prompt handling
        if (!window._pwaInstallInitialized) {
            window._pwaInstallInitialized = true;
            window.deferredPrompt = null;
            
            // Detect iOS
            const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) || 
                          (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
            const isStandalone = window.matchMedia('(display-mode: standalone)').matches || 
                                 window.navigator.standalone === true;
            
            // Show iOS install banner if in Safari and not installed
            if (isIOS && !isStandalone && !sessionStorage.getItem('iosInstallDismissed')) {
                // Wait for page to load
                setTimeout(() => {
                    showIOSInstallBanner();
                }, 2000);
            }
            
            // Handle app installed event
            window.addEventListener('appinstalled', () => {
                console.log('PWA installed successfully');
                window.deferredPrompt = null;
                
                // Hide install button and banners
                const installBtn = document.getElementById('pwa-install-btn');
                if (installBtn) {
                    installBtn.classList.add('hidden');
                }
                dismissAndroidBanner();
            });
            
            // Function to trigger PWA install
            window.installPWA = async function() {
                if (window.deferredPrompt) {
                    window.deferredPrompt.prompt();
                    const { outcome } = await window.deferredPrompt.userChoice;
                    console.log('PWA install outcome:', outcome);
                    window.deferredPrompt = null;
                    // Hide banner after install attempt
                    dismissAndroidBanner();
                }
            };
            
            // Show Android install banner (Chrome/Edge on Android)
            function showAndroidInstallBanner() {
                if (!window.deferredPrompt) return;
                
                const banner = document.createElement('div');
                banner.id = 'android-install-banner';
                banner.className = 'fixed bottom-0 left-0 right-0 bg-dark-900/95 border-t border-white/10 p-4 z-50 backdrop-blur-lg transform transition-transform duration-300';
                banner.innerHTML = `
                    <div class="max-w-lg mx-auto flex items-center space-x-4">
                        <img src="/static/icons/icon-72x72.png" alt="Forge" class="w-12 h-12 rounded-xl">
                        <div class="flex-1 min-w-0">
                            <h3 class="text-white font-medium text-sm">Install Forge</h3>
                            <p class="text-gray-400 text-xs mt-0.5">Get notifications & quick access</p>
                        </div>
                        <button onclick="installPWA()" class="px-4 py-2 bg-blue-600 hover:bg-blue-500 text-white text-sm font-medium rounded-lg transition-colors">
                            Install
                        </button>
                        <button onclick="dismissAndroidBanner()" class="text-gray-400 hover:text-white p-1">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                            </svg>
                        </button>
                    </div>
                `;
                document.body.appendChild(banner);
            }
            
            window.dismissAndroidBanner = function() {
                const banner = document.getElementById('android-install-banner');
                if (banner) {
                    banner.style.transform = 'translateY(100%)';
                    setTimeout(() => banner.remove(), 300);
                    sessionStorage.setItem('androidInstallDismissed', 'true');
                }
            };
            
            // Show Android banner when install prompt is available
            window.addEventListener('beforeinstallprompt', (e) => {
                e.preventDefault();
                window.deferredPrompt = e;
                
                // Show install button if it exists
                const installBtn = document.getElementById('pwa-install-btn');
                if (installBtn) {
                    installBtn.classList.remove('hidden');
                }
                
                // Show Android install banner if not dismissed
                if (!sessionStorage.getItem('androidInstallDismissed')) {
                    setTimeout(() => {
                        showAndroidInstallBanner();
                    }, 3000);
                }
            });
            
            // Show iOS-specific install banner (detects Safari vs Chrome)
            function showIOSInstallBanner() {
                const banner = document.createElement('div');
                banner.id = 'ios-install-banner';
                banner.className = 'fixed bottom-0 left-0 right-0 bg-dark-900/95 border-t border-white/10 p-4 z-50 backdrop-blur-lg transform transition-transform duration-300';
                
                // Detect if using Chrome on iOS (CriOS) vs Safari
                const isChromeIOS = /CriOS/.test(navigator.userAgent);
                const isFirefoxIOS = /FxiOS/.test(navigator.userAgent);
                const isEdgeIOS = /EdgiOS/.test(navigator.userAgent);
                const isOtherBrowser = isChromeIOS || isFirefoxIOS || isEdgeIOS;
                
                // Safari share icon (square with arrow up)
                const safariShareIcon = `<svg class="w-4 h-4 mx-1 text-blue-400" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2a1 1 0 0 1 1 1v10.586l2.293-2.293a1 1 0 0 1 1.414 1.414l-4 4a1 1 0 0 1-1.414 0l-4-4a1 1 0 1 1 1.414-1.414L11 13.586V3a1 1 0 0 1 1-1z" transform="rotate(180 12 12)"/><path d="M5 17a1 1 0 0 1 1 1v2h12v-2a1 1 0 1 1 2 0v3a1 1 0 0 1-1 1H5a1 1 0 0 1-1-1v-3a1 1 0 0 1 1-1z" transform="rotate(180 12 12)"/></svg>`;
                
                // Chrome menu icon (three dots)
                const chromeMenuIcon = `<svg class="w-4 h-4 mx-1 text-blue-400" fill="currentColor" viewBox="0 0 24 24"><circle cx="12" cy="5" r="2"/><circle cx="12" cy="12" r="2"/><circle cx="12" cy="19" r="2"/></svg>`;
                
                let instructions;
                if (isChromeIOS) {
                    instructions = `Tap the <span class="inline-flex items-center">${chromeMenuIcon}</span> menu, then tap <strong class="text-white">Add to Home Screen</strong>`;
                } else if (isFirefoxIOS || isEdgeIOS) {
                    instructions = `Open this page in Safari, tap <span class="inline-flex items-center">${safariShareIcon}</span> Share, then <strong class="text-white">Add to Home Screen</strong>`;
                } else {
                    // Safari or unknown - assume Safari
                    instructions = `Tap <span class="inline-flex items-center">${safariShareIcon}</span> Share at the bottom, scroll down, and tap <strong class="text-white">Add to Home Screen</strong>`;
                }
                
                banner.innerHTML = `
                    <div class="max-w-lg mx-auto flex items-center space-x-4">
                        <img src="/static/icons/icon-72x72.png" alt="Forge" class="w-12 h-12 rounded-xl">
                        <div class="flex-1 min-w-0">
                            <h3 class="text-white font-medium text-sm">Install Forge</h3>
                            <p class="text-gray-400 text-xs mt-0.5">Add to Home Screen for notifications & offline access</p>
                        </div>
                        <button onclick="dismissIOSBanner()" class="text-gray-400 hover:text-white p-1">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                            </svg>
                        </button>
                    </div>
                    <div class="max-w-lg mx-auto mt-3">
                        <p class="text-gray-400 text-xs">${instructions}</p>
                    </div>
                `;
                document.body.appendChild(banner);
            }
            
            window.dismissIOSBanner = function() {
                const banner = document.getElementById('ios-install-banner');
                if (banner) {
                    banner.style.transform = 'translateY(100%)';
                    setTimeout(() => banner.remove(), 300);
                    sessionStorage.setItem('iosInstallDismissed', 'true');
                }
            };
        }
        
        // Utility function for base64url decoding (used by push notifications)
        function urlBase64ToUint8Array(base64String) {
            const padding = '='.repeat((4 - base64String.length % 4) % 4);
            const base64 = (base64String + padding)
                .replace(/\-/g, '+')
                .replace(/_/g, '/');
            const rawData = window.atob(base64);
            const outputArray = new Uint8Array(rawData.length);
            for (let i = 0; i < rawData.length; ++i) {
                outputArray[i] = rawData.charCodeAt(i);
            }
            return outputArray;
        }
    </script>
    {% block scripts %}{% endblock %}
</body>
</html>
