<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}{{ brand.full_name }}{% endblock %}</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        brand: {
                            primary: '{{ brand.primary_color }}',
                            secondary: '{{ brand.secondary_color }}',
                            accent: '{{ brand.accent_color }}',
                        },
                        // Legacy forge colors for backwards compatibility
                        forge: {
                            navy: '{{ brand.secondary_color }}',
                            orange: '{{ brand.accent_color }}',
                        }
                    }
                }
            }
        }
    </script>
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <script src="https://unpkg.com/htmx.org@1.9.10/dist/ext/ws.js"></script>
    <link rel="icon" type="image/svg+xml" href="{{ brand.favicon_url }}">
    <style>
        :root {
            --brand-primary: {{ brand.primary_color }};
            --brand-secondary: {{ brand.secondary_color }};
            --brand-accent: {{ brand.accent_color }};
        }
        [x-cloak] { display: none !important; }
        .htmx-indicator { opacity: 0; transition: opacity 200ms ease-in; }
        .htmx-request .htmx-indicator { opacity: 1; }
        .htmx-request.htmx-indicator { opacity: 1; }
        /* Custom scrollbar */
        .scrollbar-thin::-webkit-scrollbar { width: 6px; }
        .scrollbar-thin::-webkit-scrollbar-track { background: #f1f1f1; }
        .scrollbar-thin::-webkit-scrollbar-thumb { background: #c1c1c1; border-radius: 3px; }
        .scrollbar-thin::-webkit-scrollbar-thumb:hover { background: #a1a1a1; }
        .dark .scrollbar-thin::-webkit-scrollbar-track { background: #374151; }
        .dark .scrollbar-thin::-webkit-scrollbar-thumb { background: #6b7280; }
        /* Message hover actions */
        .message-item:hover .message-actions { opacity: 1; }
        .message-actions { opacity: 0; transition: opacity 150ms; }
        /* Mention dropdown */
        .mention-dropdown { max-height: 200px; overflow-y: auto; }
        /* Brand-colored elements */
        .bg-brand-primary { background-color: var(--brand-primary); }
        .text-brand-primary { color: var(--brand-primary); }
        .border-brand-primary { border-color: var(--brand-primary); }
        .hover\\:bg-brand-primary:hover { background-color: var(--brand-primary); }
    </style>
    </style>
    {% block head %}{% endblock %}
    <script>
        // Initialize theme from localStorage before render
        if (localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            document.documentElement.classList.add('dark');
        } else {
            document.documentElement.classList.remove('dark');
        }
    </script>
</head>
<body class="h-full bg-gray-50 dark:bg-gray-900 transition-colors" hx-boost="true">
    {% block body %}
    <div class="min-h-full">
        {% block content %}{% endblock %}
    </div>
    {% endblock %}
    
    <!-- Toast notifications -->
    <div id="toast-container" class="fixed bottom-4 right-4 z-50 space-y-2"></div>
    
    <!-- Command palette -->
    <div id="command-palette" class="hidden fixed inset-0 z-50 overflow-y-auto" aria-labelledby="modal-title" role="dialog" aria-modal="true">
        <div class="flex items-start justify-center min-h-screen pt-20 px-4 text-center">
            <div class="fixed inset-0 bg-gray-500 dark:bg-gray-900 bg-opacity-75 dark:bg-opacity-80 transition-opacity" onclick="closeCommandPalette()"></div>
            <div class="relative bg-white dark:bg-gray-800 rounded-lg shadow-xl transform transition-all w-full max-w-lg">
                <div class="p-4">
                    <input type="text" 
                           id="command-input" 
                           class="w-full px-4 py-3 text-lg border-0 bg-transparent text-gray-900 dark:text-white focus:ring-0 focus:outline-none"
                           placeholder="Type a command or search..."
                           autocomplete="off">
                </div>
                <div id="command-results" class="max-h-96 overflow-y-auto border-t dark:border-gray-700">
                    <!-- Results populated by JS -->
                </div>
            </div>
        </div>
    </div>
    
    <script src="/static/app.js"></script>
    <script>
        // Initialize push notifications
        async function initPushNotifications() {
            if (!('serviceWorker' in navigator) || !('PushManager' in window)) {
                console.log('Push notifications not supported');
                return;
            }
            
            try {
                // Register service worker
                const registration = await navigator.serviceWorker.register('/static/sw.js');
                console.log('Service worker registered');
                
                // Get VAPID public key
                const response = await fetch('/push/vapid-public-key');
                if (!response.ok) {
                    console.log('Push notifications not configured on server');
                    return;
                }
                const { publicKey } = await response.json();
                
                // Check if already subscribed
                let subscription = await registration.pushManager.getSubscription();
                
                if (!subscription) {
                    // Request permission
                    const permission = await Notification.requestPermission();
                    if (permission !== 'granted') {
                        console.log('Notification permission denied');
                        return;
                    }
                    
                    // Subscribe to push
                    subscription = await registration.pushManager.subscribe({
                        userVisibleOnly: true,
                        applicationServerKey: urlBase64ToUint8Array(publicKey)
                    });
                }
                
                // Send subscription to server
                const formData = new FormData();
                formData.append('endpoint', subscription.endpoint);
                formData.append('p256dh', btoa(String.fromCharCode.apply(null, new Uint8Array(subscription.getKey('p256dh')))));
                formData.append('auth', btoa(String.fromCharCode.apply(null, new Uint8Array(subscription.getKey('auth')))));
                
                await fetch('/push/subscribe', {
                    method: 'POST',
                    body: formData
                });
                
                console.log('Push notifications enabled');
            } catch (error) {
                console.error('Error setting up push notifications:', error);
            }
        }
        
        function urlBase64ToUint8Array(base64String) {
            const padding = '='.repeat((4 - base64String.length % 4) % 4);
            const base64 = (base64String + padding)
                .replace(/\-/g, '+')
                .replace(/_/g, '/');
            const rawData = window.atob(base64);
            const outputArray = new Uint8Array(rawData.length);
            for (let i = 0; i < rawData.length; ++i) {
                outputArray[i] = rawData.charCodeAt(i);
            }
            return outputArray;
        }
        
        // Initialize push when page loads
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initPushNotifications);
        } else {
            initPushNotifications();
        }
    </script>
    {% block scripts %}{% endblock %}
</body>
</html>
