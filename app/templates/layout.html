<!DOCTYPE html>
<html lang="en" class="h-full dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>{% block title %}{{ brand.full_name }}{% endblock %}</title>
    
    <!-- PWA Meta Tags -->
    <meta name="description" content="Team communication and collaboration platform">
    <meta name="theme-color" content="#3b82f6">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Forge">
    <link rel="manifest" href="/static/manifest.json">
    
    <!-- Icons -->
    <link rel="icon" type="image/svg+xml" href="{{ brand.favicon_url }}">
    <link rel="apple-touch-icon" href="/static/icons/icon-192x192.png">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        brand: {
                            primary: '{{ brand.primary_color }}',
                            secondary: '{{ brand.secondary_color }}',
                            accent: '{{ brand.accent_color }}',
                        },
                        // Futuristic theme colors
                        forge: {
                            navy: '{{ brand.secondary_color }}',
                            blue: '{{ brand.primary_color }}',
                            purple: '{{ brand.accent_color }}',
                        },
                        // Dark theme backgrounds
                        dark: {
                            950: '#050d1a',
                            900: '#0a1628',
                            800: '#0f172a',
                            700: '#1a2744',
                            600: '#1e293b',
                            500: '#334155',
                        }
                    }
                }
            }
        }
    </script>
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <script src="https://unpkg.com/htmx.org@1.9.10/dist/ext/ws.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        }
        
        :root {
            --brand-primary: {{ brand.primary_color }};
            --brand-secondary: {{ brand.secondary_color }};
            --brand-accent: {{ brand.accent_color }};
        }
        [x-cloak] { display: none !important; }
        .htmx-indicator { opacity: 0; transition: opacity 200ms ease-in; }
        .htmx-request .htmx-indicator { opacity: 1; }
        .htmx-request.htmx-indicator { opacity: 1; }
        
        /* Futuristic space background */
        .forge-bg {
            background: linear-gradient(135deg, #0a1628 0%, #1a2744 50%, #0f172a 100%);
            position: relative;
        }
        
        .forge-bg::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                radial-gradient(ellipse at 20% 80%, rgba(59, 130, 246, 0.12) 0%, transparent 50%),
                radial-gradient(ellipse at 80% 20%, rgba(168, 85, 247, 0.08) 0%, transparent 50%),
                radial-gradient(ellipse at 50% 50%, rgba(14, 165, 233, 0.06) 0%, transparent 70%);
            pointer-events: none;
            z-index: 0;
        }
        
        /* Twinkling stars */
        .stars {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-image: 
                radial-gradient(2px 2px at 20px 30px, rgba(255,255,255,0.3), transparent),
                radial-gradient(2px 2px at 40px 70px, rgba(255,255,255,0.2), transparent),
                radial-gradient(1px 1px at 90px 40px, rgba(255,255,255,0.3), transparent),
                radial-gradient(2px 2px at 160px 120px, rgba(255,255,255,0.2), transparent),
                radial-gradient(1px 1px at 230px 90px, rgba(255,255,255,0.4), transparent),
                radial-gradient(2px 2px at 300px 60px, rgba(255,255,255,0.2), transparent),
                radial-gradient(1px 1px at 350px 150px, rgba(255,255,255,0.3), transparent),
                radial-gradient(2px 2px at 420px 80px, rgba(255,255,255,0.2), transparent),
                radial-gradient(1px 1px at 500px 200px, rgba(255,255,255,0.25), transparent),
                radial-gradient(2px 2px at 580px 140px, rgba(255,255,255,0.15), transparent),
                radial-gradient(1px 1px at 650px 50px, rgba(255,255,255,0.35), transparent),
                radial-gradient(2px 2px at 720px 180px, rgba(255,255,255,0.2), transparent);
            background-size: 800px 250px;
            animation: twinkle 10s linear infinite;
            pointer-events: none;
            z-index: 0;
        }
        
        @keyframes twinkle {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }
        
        /* Floating particles */
        .floating-particles {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            overflow: hidden;
            pointer-events: none;
            z-index: 0;
        }
        
        .particle {
            position: absolute;
            width: 4px;
            height: 4px;
            background: rgba(59, 130, 246, 0.5);
            border-radius: 50%;
            animation: float 8s infinite ease-in-out;
        }
        
        .particle:nth-child(1) { left: 10%; top: 20%; animation-delay: 0s; }
        .particle:nth-child(2) { left: 20%; top: 60%; animation-delay: 1s; background: rgba(168, 85, 247, 0.5); }
        .particle:nth-child(3) { left: 30%; top: 40%; animation-delay: 2s; }
        .particle:nth-child(4) { left: 50%; top: 80%; animation-delay: 3s; background: rgba(168, 85, 247, 0.5); }
        .particle:nth-child(5) { left: 70%; top: 30%; animation-delay: 4s; }
        .particle:nth-child(6) { left: 80%; top: 70%; animation-delay: 5s; background: rgba(14, 165, 233, 0.5); }
        .particle:nth-child(7) { left: 90%; top: 50%; animation-delay: 6s; }
        .particle:nth-child(8) { left: 15%; top: 85%; animation-delay: 7s; background: rgba(14, 165, 233, 0.5); }
        
        @keyframes float {
            0%, 100% { transform: translateY(0) scale(1); opacity: 0.5; }
            50% { transform: translateY(-20px) scale(1.2); opacity: 0.9; }
        }
        
        /* Custom scrollbar - dark theme */
        .scrollbar-thin::-webkit-scrollbar { width: 6px; }
        .scrollbar-thin::-webkit-scrollbar-track { background: rgba(30, 41, 59, 0.5); }
        .scrollbar-thin::-webkit-scrollbar-thumb { background: rgba(71, 85, 105, 0.7); border-radius: 3px; }
        .scrollbar-thin::-webkit-scrollbar-thumb:hover { background: rgba(100, 116, 139, 0.8); }
        
        /* Message hover actions */
        .message-item:hover .message-actions { opacity: 1; }
        .message-actions { opacity: 0; transition: opacity 150ms; }
        
        /* Mention dropdown */
        .mention-dropdown { max-height: 200px; overflow-y: auto; }
        
        /* Brand-colored elements */
        .bg-brand-primary { background-color: var(--brand-primary); }
        .text-brand-primary { color: var(--brand-primary); }
        .border-brand-primary { border-color: var(--brand-primary); }
        .hover\\:bg-brand-primary:hover { background-color: var(--brand-primary); }
        
        /* Futuristic glow effects */
        .glow-text { text-shadow: 0 0 30px rgba(59, 130, 246, 0.5); }
        .glow-border { box-shadow: 0 0 20px rgba(59, 130, 246, 0.3); }
        .glow-accent { box-shadow: 0 0 25px rgba(168, 85, 247, 0.3); }
        
        /* Glass morphism effect */
        .glass {
            backdrop-filter: blur(20px);
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .glass-dark {
            backdrop-filter: blur(20px);
            background: rgba(15, 23, 42, 0.7);
            border: 1px solid rgba(255, 255, 255, 0.08);
        }
        
        /* Content layer - above background effects */
        .content-layer {
            position: relative;
            z-index: 1;
        }
        
        /* Smooth transitions for theme */
        .theme-transition {
            transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
        }
    </style>
    {% block head %}{% endblock %}
    <script>
        // Initialize theme from localStorage or default to dark
        (function() {
            const prefersDark = {{ 'true' if brand.dark_mode_default else 'false' }};
            if (localStorage.theme === 'light') {
                document.documentElement.classList.remove('dark');
            } else if (localStorage.theme === 'dark' || prefersDark) {
                document.documentElement.classList.add('dark');
            } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
                document.documentElement.classList.add('dark');
            }
        })();
    </script>
</head>
<body class="h-full forge-bg text-gray-100 theme-transition" hx-boost="true">
    <!-- Background effects -->
    <div class="stars"></div>
    <div class="floating-particles">
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
    </div>
    
    {% block body %}
    <div class="min-h-full content-layer">
        {% block content %}{% endblock %}
    </div>
    {% endblock %}
    
    <!-- Toast notifications -->
    <div id="toast-container" class="fixed bottom-4 right-4 z-50 space-y-2"></div>
    
    <!-- Command palette -->
    <div id="command-palette" class="hidden fixed inset-0 z-50 overflow-y-auto" aria-labelledby="modal-title" role="dialog" aria-modal="true">
        <div class="flex items-start justify-center min-h-screen pt-20 px-4 text-center">
            <div class="fixed inset-0 bg-gray-500 dark:bg-gray-900 bg-opacity-75 dark:bg-opacity-80 transition-opacity" onclick="closeCommandPalette()"></div>
            <div class="relative bg-white dark:bg-gray-800 rounded-lg shadow-xl transform transition-all w-full max-w-lg">
                <div class="p-4">
                    <input type="text" 
                           id="command-input" 
                           class="w-full px-4 py-3 text-lg border-0 bg-transparent text-gray-900 dark:text-white focus:ring-0 focus:outline-none"
                           placeholder="Type a command or search..."
                           autocomplete="off">
                </div>
                <div id="command-results" class="max-h-96 overflow-y-auto border-t dark:border-gray-700">
                    <!-- Results populated by JS -->
                </div>
            </div>
        </div>
    </div>
    
    <script src="/static/app.js"></script>
    <script>
        // Register service worker for PWA and push notifications
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/static/sw.js')
                    .then(registration => {
                        console.log('Service Worker registered:', registration.scope);
                        
                        // Check for updates periodically
                        setInterval(() => {
                            registration.update();
                        }, 60 * 60 * 1000); // Check every hour
                    })
                    .catch(error => {
                        console.error('Service Worker registration failed:', error);
                    });
            });
        }
        
        // PWA Install prompt handling
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            // Prevent Chrome 67 and earlier from automatically showing the prompt
            e.preventDefault();
            // Stash the event so it can be triggered later
            deferredPrompt = e;
            
            // Show install button if it exists
            const installBtn = document.getElementById('pwa-install-btn');
            if (installBtn) {
                installBtn.classList.remove('hidden');
            }
        });
        
        // Handle app installed event
        window.addEventListener('appinstalled', () => {
            console.log('PWA installed successfully');
            deferredPrompt = null;
            
            // Hide install button
            const installBtn = document.getElementById('pwa-install-btn');
            if (installBtn) {
                installBtn.classList.add('hidden');
            }
        });
        
        // Function to trigger PWA install
        window.installPWA = async function() {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                console.log('PWA install outcome:', outcome);
                deferredPrompt = null;
            }
        };
        
        // Utility function for base64url decoding (used by push notifications)
        function urlBase64ToUint8Array(base64String) {
            const padding = '='.repeat((4 - base64String.length % 4) % 4);
            const base64 = (base64String + padding)
                .replace(/\-/g, '+')
                .replace(/_/g, '/');
            const rawData = window.atob(base64);
            const outputArray = new Uint8Array(rawData.length);
            for (let i = 0; i < rawData.length; ++i) {
                outputArray[i] = rawData.charCodeAt(i);
            }
            return outputArray;
        }
    </script>
    {% block scripts %}{% endblock %}
</body>
</html>
